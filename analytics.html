<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora Fest Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
            animation: fadeInDown 0.6s ease;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .refresh-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            margin-top: 1rem;
            backdrop-filter: blur(10px);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeInUp 0.6s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .metric-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .metric-change {
            font-size: 0.85rem;
            color: #10b981;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.8s ease;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 1s ease;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .loader {
            text-align: center;
            padding: 2rem;
            color: white;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .health-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.healthy {
            background: #10b981;
        }

        .status-dot.warning {
            background: #f59e0b;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.75rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <div class="header">
            <h1>Aurora Fest Analytics</h1>
            <p>Real-Time Chatbot Performance Monitoring</p>
            <div class="refresh-badge">
                <span id="lastUpdate">Loading...</span>
            </div>
            <div class="health-indicator">
                <span class="status-dot healthy" id="statusDot"></span>
                <span id="statusText">System Healthy</span>
            </div>
        </div>

        <div id="loader" class="loader">
            <div class="spinner"></div>
            <p>Loading analytics data...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Metrics Overview -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-icon"></div>
                    <div class="metric-label">Total Queries</div>
                    <div class="metric-value" id="totalQueries">0</div>
                    <div class="metric-change">All time</div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon"></div>
                    <div class="metric-label">Cache Hit Rate</div>
                    <div class="metric-value" id="cacheHitRate">0%</div>
                    <div class="metric-change" id="cacheChange">+0% efficiency</div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon"></div>
                    <div class="metric-label">Avg Confidence</div>
                    <div class="metric-value" id="avgConfidence">0%</div>
                    <div class="metric-change" id="confChange">Quality score</div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon"></div>
                    <div class="metric-label">Avg Response Time</div>
                    <div class="metric-value" id="avgResponseTime">0ms</div>
                    <div class="metric-change">Lightning fast</div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">üíæ</div>
                    <div class="metric-label">API Calls Saved</div>
                    <div class="metric-value" id="apiSaved">0</div>
                    <div class="metric-change">Via caching</div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon">‚ö†Ô∏è</div>
                    <div class="metric-label">Low Confidence</div>
                    <div class="metric-value" id="lowConfidence">0</div>
                    <div class="metric-change" id="lowConfChange">Needs review</div>
                </div>
            </div>

            <!-- API Key Usage Monitor -->
            <div style="margin: 2rem 0;">
                <h2 style="color: #1e293b; margin-bottom: 1.5rem;">üîë API Key Usage Monitor</h2>
                <div class="metrics-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="metric-card">
                        <div class="metric-icon">üî¢</div>
                        <div class="metric-label">Total Keys</div>
                        <div class="metric-value" id="total-keys">-</div>
                        <div class="metric-change">Configured</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">‚ñ∂Ô∏è</div>
                        <div class="metric-label">Current Key</div>
                        <div class="metric-value" id="current-key">-</div>
                        <div class="metric-change">Active now</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">üìä</div>
                        <div class="metric-label">Total Requests</div>
                        <div class="metric-value" id="total-requests">-</div>
                        <div class="metric-change">LLM calls</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon">ÔøΩÔøΩ</div>
                        <div class="metric-label">Key Rotations</div>
                        <div class="metric-value" id="key-rotations">-</div>
                        <div class="metric-change">Rate limit switches</div>
                    </div>
                </div>
                
                <div style="background: white; border-radius: 16px; padding: 1.5rem; margin-top: 1.5rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                    <h3 style="color: #1e293b; margin-bottom: 1rem;">Usage Distribution</h3>
                    <div id="api-key-usage"></div>
                </div>
            </div>


            <!-- Charts -->
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-title">
                        <span></span> Top Intents Distribution
                    </div>
                    <canvas id="intentsChart"></canvas>
                </div>

                <div class="chart-card">
                    <div class="chart-title">
                        <span></span> Cache Performance
                    </div>
                    <canvas id="cacheChart"></canvas>
                </div>
            </div>

            <!-- Recent Queries Table -->
            <div class="table-card">
                <div class="chart-title">
                    <span></span> Recent Queries Summary
                </div>
                <div style="overflow-x: auto;">
                    <table id="queriesTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Query</th>
                                <th>Intent</th>
                                <th>Confidence</th>
                                <th>Cached</th>
                                <th>Response Time</th>
                            </tr>
                        </thead>
                        <tbody id="queriesBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- FULL INTERACTION LOGS -->
            <div class="table-card" style="margin-top: 1.5rem;">
                <div class="chart-title">
                    <span></span> Complete Interaction Logs
                    <button onclick="exportToCSV()"
                        style="margin-left: auto; padding: 0.5rem 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        üì• Export CSV
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="fullLogsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Time</th>
                                <th>User ID</th>
                                <th>Query (Full)</th>
                                <th>Answer (Full)</th>
                                <th>Intent</th>
                                <th>Confidence</th>
                                <th>Cached</th>
                                <th>Device</th>
                                <th>Browser</th>
                                <th>OS</th>
                                <th>Response Type</th>
                                <th>Response Time</th>
                            </tr>
                        </thead>
                        <tbody id="fullLogsBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 2rem; color: #64748b;">
                                    Loading detailed logs from SQLite database...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8000'
            : '';

        let intentsChart, cacheChart;
        let fullLogsData = [];

        async function fetchAnalytics() {
            try {
                const response = await fetch(`${API_URL}/analytics`);
                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                console.error('Error fetching analytics:', error);
                document.getElementById('statusDot').className = 'status-dot warning';
                document.getElementById('statusText').textContent = 'Connection Issue';
            }
        }

        async function fetchFullLogs() {
            try {
                const response = await fetch(`${API_URL}/interactions/all`);
                if (response.ok) {
                    const data = await response.json();
                    fullLogsData = data.interactions || [];
                    updateFullLogsTable(fullLogsData);
                }
            } catch (error) {
                console.error('Error fetching full logs:', error);
                document.getElementById('fullLogsBody').innerHTML = `
                    <tr><td colspan="12" style="text-align: center; padding: 2rem; color: #ef4444;">
                        ‚ö†Ô∏è Could not load interaction logs. Endpoint may not be available yet.
                    </td></tr>
                `;
            }
        }

        // XSS Protection: Sanitize HTML in user input
        function sanitizeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function exportToCSV() {
            if (fullLogsData.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['ID', 'Timestamp', 'User ID', 'Query', 'Answer', 'Intent', 'Confidence', 'Response Type', 'Response Time (ms)'];
            const csvContent = [
                headers.join(','),
                ...fullLogsData.map(row => [
                    row.interaction_id,
                    row.timestamp,
                    row.user_id,
                    `"${(row.query_text || '').replace(/"/g, '""')}"`,
                    `"${(row.answer || '').replace(/"/g, '""')}"`,
                    row.detected_intent,
                    row.confidence_score,
                    row.response_type,
                    row.response_time_ms
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aurora_fest_logs_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function updateDashboard(data) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // Update metrics
            const legacy = data.legacy_analytics || {};
            const cache = data.cache_stats || {};
            const prod = data.production_stats || {};

            document.getElementById('totalQueries').textContent = legacy.total_queries || 0;
            document.getElementById('cacheHitRate').textContent = `${cache.cache_hit_rate || 0}%`;
            document.getElementById('avgConfidence').textContent = `${Math.round((prod.avg_confidence || 0) * 100)}%`;
            document.getElementById('avgResponseTime').textContent = `${Math.round(legacy.avg_response_time || 0)}ms`;
            document.getElementById('apiSaved').textContent = cache.api_calls_saved || 0;
            document.getElementById('lowConfidence').textContent = prod.low_confidence_count || 0;

            // Update change indicators
            if (cache.cache_hit_rate >= 60) {
                document.getElementById('cacheChange').textContent = 'üî• Excellent!';
                document.getElementById('cacheChange').className = 'metric-change';
            } else if (cache.cache_hit_rate >= 30) {
                document.getElementById('cacheChange').textContent = 'üëç Good';
                document.getElementById('cacheChange').className = 'metric-change';
            } else {
                document.getElementById('cacheChange').textContent = '‚ö†Ô∏è Low';
                document.getElementById('cacheChange').className = 'metric-change negative';
            }

            if ((prod.avg_confidence || 0) >= 0.7) {
                document.getElementById('confChange').textContent = 'High Quality';
            } else if ((prod.avg_confidence || 0) >= 0.5) {
                document.getElementById('confChange').textContent = '‚ö†Ô∏è Medium Quality';
            } else {
                document.getElementById('confChange').textContent = 'Needs Review';
            }

            // Update intents chart
            updateIntentsChart(prod.top_intents || {});

            // Update cache chart
            updateCacheChart(cache);

            // Update recent queries table
            updateQueriesTable(legacy.recent_queries || []);

            // Update timestamp
            const now = new Date();
            document.getElementById('lastUpdate').textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }

        function updateIntentsChart(topIntents) {
            const ctx = document.getElementById('intentsChart').getContext('2d');

            if (intentsChart) {
                intentsChart.destroy();
            }

            const labels = Object.keys(topIntents);
            const values = Object.values(topIntents);

            intentsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#4facfe',
                            '#43e97b'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateCacheChart(cacheStats) {
            const ctx = document.getElementById('cacheChart').getContext('2d');

            if (cacheChart) {
                cacheChart.destroy();
            }

            const cacheHits = cacheStats.cache_hits || 0;
            const cacheMisses = (cacheStats.cache_size || 0) - cacheHits;

            cacheChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Cache Hits', 'Cache Misses', 'API Calls Saved'],
                    datasets: [{
                        label: 'Count',
                        data: [cacheHits, cacheMisses, cacheStats.api_calls_saved || 0],
                        backgroundColor: [
                            '#10b981',
                            '#ef4444',
                            '#667eea'
                        ],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateQueriesTable(queries) {
            const tbody = document.getElementById('queriesBody');
            tbody.innerHTML = '';

            queries.forEach(q => {
                const row = tbody.insertRow();

                // Time
                const timeCell = row.insertCell();
                const time = new Date(q.timestamp);
                timeCell.textContent = time.toLocaleTimeString();

                // Query
                const queryCell = row.insertCell();
                queryCell.textContent = q.query.substring(0, 50) + (q.query.length > 50 ? '...' : '');

                // Intent
                const intentCell = row.insertCell();
                intentCell.innerHTML = `<span class="badge badge-info">${q.intent || 'general'}</span>`;

                // Confidence
                const confCell = row.insertCell();
                const conf = Math.round((q.confidence || 0) * 100);
                if (conf >= 70) {
                    confCell.innerHTML = `<span class="badge badge-success">${conf}%</span>`;
                } else if (conf >= 50) {
                    confCell.innerHTML = `<span class="badge badge-warning">${conf}%</span>`;
                } else {
                    confCell.innerHTML = `<span class="badge badge-warning">${conf}%</span>`;
                }

                // Cached
                const cachedCell = row.insertCell();
                cachedCell.innerHTML = q.cached ? 'Yes' : 'üîÑ No';

                // Response Time
                const timeRespCell = row.insertCell();
                timeRespCell.textContent = `${Math.round(q.response_time_ms || 0)}ms`;
            });
        }

        function updateFullLogsTable(logs) {
            const tbody = document.getElementById('fullLogsBody');
            tbody.innerHTML = '';

            if (logs.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="9" style="text-align: center; padding: 2rem; color: #64748b;">
                        No interactions logged yet. Start chatting to see data here!
                    </td></tr>
                `;
                return;
            }

            logs.forEach(log => {
                const row = tbody.insertRow();

                // ID (shortened)
                const idCell = row.insertCell();
                idCell.textContent = log.interaction_id.substring(0, 8) + '...';
                idCell.style.fontSize = '0.8rem';

                // Time
                const timeCell = row.insertCell();
                const time = new Date(log.timestamp);
                timeCell.textContent = time.toLocaleTimeString();

                // User ID
                const userCell = row.insertCell();
                userCell.textContent = log.user_id;
                userCell.style.fontFamily = 'monospace';
                userCell.style.fontSize = '0.8rem';

                // Query (Full)
                const queryCell = row.insertCell();
                queryCell.textContent = log.query_text;
                queryCell.style.maxWidth = '200px';
                queryCell.style.whiteSpace = 'normal';

                // Answer (Full)
                const answerCell = row.insertCell();
                answerCell.textContent = log.answer;
                answerCell.style.maxWidth = '300px';
                answerCell.style.whiteSpace = 'normal';

                // Intent
                const intentCell = row.insertCell();
                intentCell.innerHTML = `<span class="badge badge-info">${log.detected_intent || 'general'}</span>`;

                // Confidence
                const confCell = row.insertCell();
                const conf = Math.round((log.confidence_score || 0) * 100);
                if (conf >= 70) {
                    confCell.innerHTML = `<span class="badge badge-success">${conf}%</span>`;
                } else if (conf >= 50) {
                    confCell.innerHTML = `<span class="badge badge-warning">${conf}%</span>`;
                } else {
                    confCell.innerHTML = `<span class="badge badge-warning">${conf}%</span>`;
                }

                // Cached
                const cachedCell = row.insertCell();
                if (log.cached === 1 || log.cached === true) {
                    cachedCell.innerHTML = 'Yes';
                    cachedCell.style.color = '#10b981';
                    cachedCell.style.fontWeight = '600';
                } else {
                    cachedCell.innerHTML = 'üîÑ No';
                    cachedCell.style.color = '#64748b';
                }

                // Device Type
                const deviceCell = row.insertCell();
                const deviceIcon = log.device_type === 'Mobile' ? '' : (log.device_type === 'Tablet' ? '' : (log.device_type === 'Desktop' ? '' : ''));
                deviceCell.innerHTML = `${deviceIcon} ${log.device_type || 'Unknown'}`;
                deviceCell.style.fontSize = '0.85rem';

                // Browser
                const browserCell = row.insertCell();
                browserCell.textContent = log.browser || 'Unknown';
                browserCell.style.fontSize = '0.8rem';
                browserCell.style.whiteSpace = 'nowrap';

                // OS
                const osCell = row.insertCell();
                osCell.textContent = log.os || 'Unknown';
                osCell.style.fontSize = '0.8rem';
                osCell.style.whiteSpace = 'nowrap';

                // Response Type
                const typeCell = row.insertCell();
                typeCell.textContent = log.response_type || 'unknown';
                typeCell.style.fontSize = '0.85rem';

                // Response Time
                const timeRespCell = row.insertCell();
                timeRespCell.textContent = `${Math.round(log.response_time_ms || 0)}ms`;
            });
        }

        // Initial load
        fetchAnalytics();
        fetchFullLogs();  // Load full logs on page load

        // Auto-refresh every 5 seconds
        setInterval(fetchAnalytics, 5000);
        setInterval(fetchFullLogs, 10000);  // Refresh full logs every 10 seconds

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // API KEY USAGE MONITORING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadAPIKeyStats() {
            try {
                const response = await fetch('/api-stats');
                const data = await response.json();
                
                if (data.status === 'ok') {
                    const stats = data.api_keys;
                    
                    // Update metric cards
                    document.getElementById('total-keys').textContent = stats.total_keys;
                    document.getElementById('current-key').textContent = stats.current_key_index;
                    document.getElementById('total-requests').textContent = stats.total_requests.toLocaleString();
                    document.getElementById('key-rotations').textContent = stats.key_rotations;
                    
                    // Create usage distribution visualization
                    const usageHTML = stats.usage_per_key.map(key => `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; color: ${key.is_current ? '#10b981' : '#64748b'};">
                                    ${key.is_current ? '‚ñ∂Ô∏è' : '‚ö™'} Key #${key.key_number}
                                </span>
                                <span style="color: #64748b; font-size: 0.9rem;">
                                    ${key.requests.toLocaleString()} requests (${key.percentage}%)
                                </span>
                            </div>
                            <div style="background: #f1f5f9; border-radius: 10px; height: 24px; overflow: hidden;">
                                <div style="
                                    background: ${key.is_current ? 'linear-gradient(90deg, #10b981, #3b82f6)' : '#cbd5e1'};
                                    height: 100%;
                                    width: ${key.percentage}%;
                                    transition: width 0.3s ease;
                                    border-radius: 10px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-size: 0.75rem;
                                    font-weight: 600;
                                ">
                                    ${key.percentage > 10 ? key.percentage + '%' : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('api-key-usage').innerHTML = usageHTML || 
                        '<p style="color: #94a3b8; text-align: center; padding: 1rem;">No LLM requests yet</p>';
                }
            } catch (error) {
                console.error('Error loading API stats:', error);
                document.getElementById('total-keys').textContent = 'Error';
                document.getElementById('current-key').textContent = 'Error';
                document.getElementById('total-requests').textContent = 'Error';
                document.getElementById('key-rotations').textContent = 'Error';
            }
        }

        // Load immediately and refresh every 5 seconds
        loadAPIKeyStats();
        setInterval(loadAPIKeyStats, 5000);

    </script>
</body>

</html>